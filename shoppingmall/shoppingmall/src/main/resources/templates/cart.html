<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>장바구니</title>
    <link rel="stylesheet" href="/css/cart.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="header">
    <a href="/" id="home_logo">
        <img src="/images/icons/logo.png" alt="Home Logo"/>
    </a>
</div>
<h2>장바구니</h2>
<table>
    <thead>
    <th>장바구니 목록</th>
    </thead>
    <tbody>
    <tr class="clickable-row" th:each="cart, iterStat : ${carts}">
        <td id="product"><img th:src="@{'/images/uploads/' + ${cart.products.photo}}" alt="Product Image" height="80" width="80">
            <span id="name" th:text="${cart.products.product_name}"></span></td>
        <td>
            <div class="quantity-controls">
                <button type="button" class="decrease-quantity" th:data-cart-item-id="${cart.id}">-</button>
                <span class="quantity" th:text="${cart.quantity}"></span>
                <button type="button" class="increase-quantity" th:data-cart-item-id="${cart.id}">+</button>
            </div>
        </td>
        <td th:text="${cart.products.price * cart.quantity}"></td>
        <td><button id="coupon">쿠폰 적용</button></td>
    </tr>
    </tbody>
</table>
<h3>총 합계: <span id="totalAmount" th:text="${total}"></span></h3>
<button type="button" id="buy">결제하기</button>
<script>
    $(document).ready(function() {
        function updatePriceAndTotal() {
            var totalAmount = 0;
            $('tbody tr').each(function() {
                var quantity = parseInt($(this).find('.quantity').text());
                var price = parseFloat($(this).find('td:nth-child(3)').text().replace('원', ''));
                var totalPrice = quantity * price;
                $(this).find('.total-price').text(totalPrice + '원');
                totalAmount += totalPrice;
            });
            $('#totalAmount').text(totalAmount + '원');
        }

        $('.increase-quantity, .decrease-quantity').on('click', function() {
            var cartItemId = $(this).data('cart-item-id');
            var quantitySpan = $(this).siblings('.quantity');
            var currentQuantity = parseInt(quantitySpan.text());
            var newQuantity = $(this).hasClass('increase-quantity') ? currentQuantity + 1 : currentQuantity - 1;

            if (newQuantity < 1) return; // 수량이 1보다 작아지지 않도록 함

            quantitySpan.text(newQuantity);

            // 서버에 수량 업데이트 요청

            $.post('/cart/update', { cartItemId: cartItemId, quantity: newQuantity }, function(response) {
                if (response === 'success') {
                    updatePriceAndTotal();
                } else {
                    alert('Failed to update cart item quantity.');
                }
            });
        });

        // 초기 로딩 시 가격 업데이트
        updatePriceAndTotal();
    });
</script>
</body>
</html>
