<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Fast Mall - 상품 상세 정보</title>
    <script>
        function handleSubmit(event) {
            event.preventDefault(); // 기본 폼 제출 동작 방지
            const form = event.target;

            // 폼 데이터를 객체로 생성
            const formData = new FormData(form);

            // Fetch API를 사용하여 비동기 요청 보내기
            fetch(form.action, {
                method: form.method,
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.text())
                .then(data => {
                    if (data === 'success') {
                        if (data === 'success') {
                            alert('상품이 장바구니에 추가되었습니다.');
                        } else if (data === 'not_logged_in') {
                            alert('로그인을 해주세요.');
                        } else {
                            alert('상품 추가에 실패했습니다.');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('상품 추가에 실패했습니다.');
                });
        }

        function incrementValue() {
            let value = parseInt(document.getElementById('quantity').value, 10);
            value = isNaN(value) ? 0 : value;
            value++;
            document.getElementById('quantity').value = value;
            updateTotalPrice();
        }

        function decrementValue() {
            let value = parseInt(document.getElementById('quantity').value, 10);
            value = isNaN(value) ? 0 : value;
            value--;
            value = value < 1 ? 1 : value; // 최소 수량 1로 설정
            document.getElementById('quantity').value = value;
            updateTotalPrice();
        }

        function updateTotalPrice() {
            const price = parseFloat(document.getElementById('price').textContent);
            const quantity = parseInt(document.getElementById('quantity').value, 10);
            const totalPrice = price * quantity;
            document.getElementById('totalPrice').textContent = totalPrice.toString();
        }
    </script>
</head>
<body>
<div class="header">
    <a href="/" id="home_logo">
        <img src="/images/icons/logo.png" alt="Home Logo"/>
    </a>
</div>
<h1>상품 상세 정보</h1>
<div>
    <h2 th:text="${product.product_name}"></h2>
    <img th:src="@{'/images/uploads/' + ${product.photo}}" alt="Product Image" height="400" width="400">
    <p>판매자: <span th:text="${product.seller_id}"></span></p>
    <p>설명: <span th:text="${product.description}"></span></p>
    <p>가격: <span id="price" th:text="${product.price}"></span></p>
</div>
<form th:action="@{/cart/add}" method="post" onsubmit="handleSubmit(event)">
    <input type="hidden" name="productId" th:value="${product.id}"/>
    <input type="hidden" id="query" name="query" th:value="${query}"/>
    <input type="hidden" id="category" name="category" th:value="${category}"/>
    <input type="hidden" id="sellerId" name="sellerId" th:value="${sellerId}"/>
    <div>
        <button type="button" onclick="decrementValue()">-</button>
        <input type="number" id="quantity" name="quantity" value="1" readonly />
        <button type="button" onclick="incrementValue()">+</button>
    </div>
    <p>결제 가격: <span id="totalPrice" th:text="${product.price}"></span></p>
    <button type="submit">장바구니 담기</button>
</form>
<a th:href="@{/search(query=${query}, category=${category}, sellerID=${sellerId})}" style="color: #3180d1">검색 결과로 돌아가기</a>
</body>
</html>
